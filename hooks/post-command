echo "~~~ post-command test"

echo "BUILDKITE_TRIGGERED_FROM_BUILD_ID $BUILDKITE_TRIGGERED_FROM_BUILD_ID"
echo "BUILDKITE_JOB_ID $BUILDKITE_JOB_ID"
echo "BUILDKITE_JOB_KEY $BUILDKITE_JOB_KEY"
echo "BUILDKITE_JOB_NAME $BUILDKITE_JOB_NAME"
echo "BUILDKITE_STEP_KEY $BUILDKITE_STEP_KEY"
echo "BUILDKITE_LABEL $BUILDKITE_LABEL"
echo "BUILDKITE_COMMAND $BUILDKITE_COMMAND"
echo "BUILDKITE_COMMAND_EXIT_STATUS $BUILDKITE_COMMAND_EXIT_STATUS"

# 1) create the analysis folder & artifacts
set +e # never fail the job because of analysis
readonly analysis_dir="artifacts/analysis"
mkdir -p "$analysis_dir"
mv $BUILDKITE_JOB_ID.log "$analysis_dir/log"
echo "$BUILDKITE_COMMAND_EXIT_STATUS" > "$analysis_dir/exit_code"

ls -al "$analysis_dir"
buildkite-agent artifact upload "$analysis_dir/**"

# 2) do job analysis
# input: { pipelineSlug, jobKey, analysis } folder
# e.g.: { web-code-runner, lint, analysisDir }
# output: { category, subCategory }, e.g.: { "category": "InfraFailure", "subCategory": "generic" }
if [ -x tools/analyzers/run.py ]; then
  result=$(python tools/analyzers/run.py --pipeline "$BUILDKITE_PIPELINE_SLUG" --jobKey "$BUILDKITE_STEP_KEY" --analysisDir "$analysis_dir")
fi
cat $result | buildkite-agent meta-data set "JOB_ANALYSIS-$BUILDKITE_JOB_ID"

set -e
