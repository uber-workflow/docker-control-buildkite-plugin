#!/bin/bash

set -eo pipefail

readonly dir="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"

# capture analysis data
. "$dir/command-body.sh" | tee $BUILDKITE_JOB_ID.log
exit_code="${PIPESTATUS[0]}"

# DO ANALYSIS (or do it in post-command hook)
# TODO: hide behind an optional ANALYZE_JOB=true/false flag (default to false?)
# 1) create the analysis folder & artifacts
set +e # never fail the job because of analysis
mkdir -p artifacts/analysis
mv $BUILDKITE_JOB_ID.log artifacts/analysis/log
echo "$exit_code" > artifacts/analysis/exit_code

ls -al artifacts/analysis

buildkite-agent artifact upload "artifacts/analysis/**"

# 2) do analysis
# input: artifacts/analysis folder
# output: { category, subCategory, shouldRetry }

# maybe: clean up artifacts/analysis folder when done analyzing

# re-map exit code if shouldRetry is true here! (use a special exit code to signify retry to Buildkite)

set -e
